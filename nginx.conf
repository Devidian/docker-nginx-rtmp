daemon off;

error_log /dev/stdout info;

events {
    worker_connections 1024;
}

rtmp {
    server {
        listen ${RTMP_PORT};
        chunk_size 4000;
        
        # Ingest part
        application live {
            live on;
            deny play all;

            # should only return 2xx or 4xx no redirect for the workaround
            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            # push url name=$name seems to be broken, so we need this workaround
            push rtmp://127.0.0.1:1935/push_redirect?target=transcode;
            push rtmp://127.0.0.1:1935/push_redirect?target=custom01;
            push rtmp://127.0.0.1:1935/push_redirect?target=custom02;
            push rtmp://127.0.0.1:1935/push_redirect?target=custom03;
            push rtmp://127.0.0.1:1935/push_redirect?target=custom04;
        }

        application push_redirect {
            live on;
            deny play all;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;
        }

        ######################################
        # Transcoder part 
        # 16:9
        application transcode169 {
            live on;
            allow play ${RTMP_TRANSCODE_IP};
            deny play all;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            exec ffmpeg -i rtmp://${RTMP_TRANSCODE_IP}:1935/transcode169/$name
              -c copy -f flv rtmp://${RTMP_HLS_IP}:1935/hls/$name_src
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 2500k -f flv -g 30 -r 30 -s 1280x720 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hls/$name_720p2628kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 1000k -f flv -g 30 -r 30 -s 854x480 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hls/$name_480p1128kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 750k -f flv -g 30 -r 30 -s 640x360 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hls/$name_360p878kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 400k -f flv -g 30 -r 30 -s 426x240 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hls/$name_240p528kbs
              -c:a libfdk_aac -b:a 64k -c:v libx264 -b:v 200k -f flv -g 15 -r 15 -s 426x240 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hls/$name_240p264kbs;
        }
        # 9:16
        application transcode916 {
            live on;
            allow play ${RTMP_TRANSCODE_IP};
            deny play all;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            exec ffmpeg -i rtmp://${RTMP_TRANSCODE_IP}:1935/transcode169/$name
              -c copy -f flv rtmp://${RTMP_HLS_IP}:1935/hlsp/$name_src
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 2500k -f flv -g 30 -r 30 -s 720x1280 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsp/$name_p720p2628kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 1000k -f flv -g 30 -r 30 -s 480x854 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsp/$name_p480p1128kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 750k -f flv -g 30 -r 30 -s 360x640 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsp/$name_p360p878kbs
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 400k -f flv -g 30 -r 30 -s 240x426 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsp/$name_p240p528kbs
              -c:a libfdk_aac -b:a 64k -c:v libx264 -b:v 200k -f flv -g 15 -r 15 -s 240x426 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsp/$name_p240p264kbs;
        }
        # 16:9 - low bandwidth only
        application transcode169low {
            live on;
            allow play ${RTMP_TRANSCODE_IP};
            deny play all;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            exec ffmpeg -i rtmp://${RTMP_TRANSCODE_IP}:1935/transcode169/$name
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 400k -f flv -g 30 -r 30 -s 426x240 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlslow/$name_240p528kbs
              -c:a libfdk_aac -b:a 64k -c:v libx264 -b:v 200k -f flv -g 15 -r 15 -s 426x240 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlslow/$name_240p264kbs;
        }
        # 9:16 - low bandwidth only
        application transcode916low {
            live on;
            allow play ${RTMP_TRANSCODE_IP};
            deny play all;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            exec ffmpeg -i rtmp://${RTMP_TRANSCODE_IP}:1935/transcode169/$name
              -c:a libfdk_aac -b:a 128k -c:v libx264 -b:v 400k -f flv -g 30 -r 30 -s 240x426 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsplow/$name_p240p528kbs
              -c:a libfdk_aac -b:a 64k -c:v libx264 -b:v 200k -f flv -g 15 -r 15 -s 240x426 -preset superfast -profile:v baseline rtmp://${RTMP_HLS_IP}:1935/hlsplow/$name_p240p264kbs;
        }
        # Transcoder end
        ######################################
        

        ######################################
        # HLS distribution part
        # default 16:9 (landscape)
        application hls {
            live on;
            hls on;
            hls_fragment_naming system;
            hls_fragment 5;
            hls_playlist_length 10;
            hls_path /opt/data/hls;
            hls_nested on;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            hls_variant _src BANDWIDTH=7000000;
            hls_variant _720p2628kbs BANDWIDTH=2628000,RESOLUTION=1280x720;
            hls_variant _480p1128kbs BANDWIDTH=1128000,RESOLUTION=854x480;
            hls_variant _360p878kbs BANDWIDTH=878000,RESOLUTION=640x360;
            hls_variant _240p528kbs BANDWIDTH=528000,RESOLUTION=426x240;
            hls_variant _240p264kbs BANDWIDTH=264000,RESOLUTION=426x240;
        }

        # 9:16
        application hlsp {
            live on;
            hls on;
            hls_fragment_naming system;
            hls_fragment 5;
            hls_playlist_length 10;
            hls_path /opt/data/hlsp;
            hls_nested on;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            hls_variant _src BANDWIDTH=7000000;
            hls_variant _p720p2628kbs BANDWIDTH=2628000,RESOLUTION=720x1280;
            hls_variant _p480p1128kbs BANDWIDTH=1128000,RESOLUTION=480x854;
            hls_variant _p360p878kbs BANDWIDTH=878000,RESOLUTION=360x640;
            hls_variant _p240p528kbs BANDWIDTH=528000,RESOLUTION=240x426;
            hls_variant _p240p264kbs BANDWIDTH=264000,RESOLUTION=240x426;
        }

        # default 16:9 (landscape) - low bandwidth
        application hlslow {
            live on;
            hls on;
            hls_fragment_naming system;
            hls_fragment 5;
            hls_playlist_length 10;
            hls_path /opt/data/hlslow;
            hls_nested on;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            hls_variant _240p528kbs BANDWIDTH=528000,RESOLUTION=426x240;
            hls_variant _240p264kbs BANDWIDTH=264000,RESOLUTION=426x240;
        }

        # 9:16 - low bandwidth
        application hlsplow {
            live on;
            hls on;
            hls_fragment_naming system;
            hls_fragment 5;
            hls_playlist_length 10;
            hls_path /opt/data/hlsplow;
            hls_nested on;

            on_publish ${STREAM_AUTH_HOST}/push/notify;
            on_publish_done ${STREAM_AUTH_HOST}/push/notify;
            notify_method get;

            hls_variant _p240p528kbs BANDWIDTH=528000,RESOLUTION=240x426;
            hls_variant _p240p264kbs BANDWIDTH=264000,RESOLUTION=240x426;
        }
    }
}

http {
    root /www/static;
    sendfile off;
    tcp_nopush on;
    access_log /dev/stdout combined;

    # Uncomment these lines to enable SSL.
    # ssl_ciphers         HIGH:!aNULL:!MD5;
    # ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    # ssl_session_cache   shared:SSL:10m;
    # ssl_session_timeout 10m;

    map $arg_tcurl $target_new_destination {
        '~target=transcode'     rtmp://${RTMP_TRANSCODE_IP}:1935/transcode169;
        '~target=source'        rtmp://${RTMP_TRANSCODE_IP}:1935/hls/${arg_name}_source;
    }
    map $arg_app $target_new_status {
        'live'          1;
        'transcode169'  1;
        'transcode916'  1;
        'hls'           1;
        'push_redirect' 1;
    }

    server {
        listen ${HTTP_PORT};

        # Uncomment these lines to enable SSL.
        # Update the ssl paths with your own certificate and private key.
            
        # listen ${HTTPS_PORT} ssl;
        # ssl_certificate     /opt/certs/example.com.crt;
        # ssl_certificate_key /opt/certs/example.com.key;

        location /push/notify {
            error_page 420 = @push_notify;
        
            if ( $args ~ "app=" ) { return 420; }
            return 403;
        }
 
        location @push_notify {
            if ($target_new_destination) {
                return 303 $target_new_destination;
            }
            if ($target_new_status) {
                return 200;
            }
            return 403;
        }

        location /hlsp {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /opt/data;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /opt/data;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }
        
        location /hlsplow {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /opt/data;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        location /hlslow {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /opt/data;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        location /live {
          alias /opt/data/hls;
          types {
              application/vnd.apple.mpegurl m3u8;
              video/mp2t ts;
          }
          add_header Cache-Control no-cache;
          add_header Access-Control-Allow-Origin *;
        }

        location /live/low {
          alias /opt/data/hlslow;
          types {
              application/vnd.apple.mpegurl m3u8;
              video/mp2t ts;
          }
          add_header Cache-Control no-cache;
          add_header Access-Control-Allow-Origin *;
        }

        location /live/p {
          alias /opt/data/hlsp;
          types {
              application/vnd.apple.mpegurl m3u8;
              video/mp2t ts;
          }
          add_header Cache-Control no-cache;
          add_header Access-Control-Allow-Origin *;
        }

        location /live/p/low {
          alias /opt/data/hlsplow;
          types {
              application/vnd.apple.mpegurl m3u8;
              video/mp2t ts;
          }
          add_header Cache-Control no-cache;
          add_header Access-Control-Allow-Origin *;
        }

        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root /www/static;
        }

        location /crossdomain.xml {
            default_type text/xml;
            expires 24h;
        }
    }
}
